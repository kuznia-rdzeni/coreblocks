<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Core verification &mdash; Coreblocks documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Instruction Cache" href="../components/icache.html" />
    <link rel="prev" title="Problem checklist" href="../problem-checklist.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Coreblocks documentation
            <img src="../_static/logo-banner.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../home.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assumptions.html">List of assumptions made during development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development-environment.html">Development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transactions.html">Documentation for Coreblocks transaction framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/overview.html">Scheduler overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shared-structs/implementation/rs-impl.html">Proposition of Reservation Station implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shared-structs/rs.html">Reservation Station</a></li>
<li class="toctree-l1"><a class="reference internal" href="../current-graph.html">Full transaction-method graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../problem-checklist.html">Problem checklist</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Core verification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#synthesis">Synthesis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#manual-reproduction">Manual reproduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#benchmarking">Benchmarking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#benchmarks-manual-execution">Benchmarks manual execution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#regression-tests">Regression tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#regression-tests-manual-execution">Regression tests manual execution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/icache.html">Instruction Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellany/exceptions-summary.html">Summary of papers about interrupts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Coreblocks documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Core verification</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/synthesis/synthesis.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="core-verification">
<h1>Core verification<a class="headerlink" href="#core-verification" title="Permalink to this heading"></a></h1>
<p>Coreblocks is verified at several levels of abstraction. Beside of unit tests and module tests, we also
synthesise the core to the ECP5 FPGA target, to check that it can work in reality. Performance is verified
using synthesis results and a set of benchmarks simulated with cycle precision in cocotb. We also verify
correctness of the core behaviour by running assembler tests from <a class="reference external" href="https://github.com/riscv-software-src/riscv-tests/tree/master">riscv-tests</a>
and <a class="reference external" href="https://github.com/riscv-non-isa/riscv-arch-test">riscv-arch-tests</a>.</p>
<p>These three verification steps are automatically run by CI on every commit delivered to the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch. Running
the checks in CI allow us to collect historical data, which are available in the form of the graphs
on a dedicated <a class="reference external" href="https://kuznia-rdzeni.github.io/coreblocks/dev/benchmark/">benchmark subpage</a>.</p>
<p>In CI we use pre-built docker containers, which are publicly available on our <a class="reference external" href="https://github.com/orgs/kuznia-rdzeni/packages">github page</a>.
In the following subsections we provide the instructions on how to manually run verification steps using these containers.
They can be recreated using standard docker build commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">--</span><span class="n">platform</span> <span class="n">linux</span><span class="o">/</span><span class="n">amd64</span> <span class="o">-</span><span class="n">t</span> <span class="s2">&quot;amaranth-synth:latest&quot;</span> <span class="o">-</span><span class="n">f</span> <span class="o">./</span><span class="n">docker</span><span class="o">/</span><span class="n">AmaranthSynthECP5</span><span class="o">.</span><span class="n">Dockerfile</span> <span class="o">.</span>
</pre></div>
</div>
<div class="section" id="synthesis">
<h2>Synthesis<a class="headerlink" href="#synthesis" title="Permalink to this heading"></a></h2>
<p>The basic step in verification is to see if it is possible to synthesise the <code class="docutils literal notranslate"><span class="pre">Core</span></code> circuit. This allows us to
control the level of complexity of the core. Although Coreblocks is an educational core, we want it to be practical.
It should have an acceptable maximum frequency and shouldn’t use too many resources, so it can be run
on a FPGA. The synthesis step ensures that these requirements are met. In addition, it checks whether the code that is acceptable
for Amaranth is also acceptable for the synthesis tools.</p>
<p>The main properties collected in the synthesis step:</p>
<ul class="simple">
<li><p>Max clock frequency</p></li>
<li><p>Number of logic cells used</p></li>
<li><p>Number of carry cells used</p></li>
<li><p>Number of RAM cells used</p></li>
<li><p>Number of DFF cells used</p></li>
</ul>
<p>The configuration of the docker container is described in the <code class="docutils literal notranslate"><span class="pre">AmaranthSynthECP5.Dockerfile</span></code>, which can be found in
<a class="reference external" href="https://github.com/orgs/kuznia-rdzeni/packages/container/package/amaranth-synth">our repo</a>.</p>
<div class="section" id="manual-reproduction">
<h3>Manual reproduction<a class="headerlink" href="#manual-reproduction" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>docker<span class="w"> </span>pull<span class="w"> </span>ghcr.io/kuznia-rdzeni/amaranth-synth:latest
sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>ghcr.io/kuznia-rdzeni/amaranth-synth:latest
git<span class="w"> </span>clone<span class="w"> </span>--depth<span class="o">=</span><span class="m">1</span><span class="w"> </span>https://github.com/kuznia-rdzeni/coreblocks.git
<span class="nb">cd</span><span class="w"> </span>coreblocks
apt<span class="w"> </span>update
apt<span class="w"> </span>install<span class="w"> </span>python3.11-venv
python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
.<span class="w"> </span>venv/bin/activate
python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
pip3<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements-dev.txt
<span class="nv">PYTHONHASHSEED</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>./scripts/synthesize.py<span class="w"> </span>--verbose<span class="w"> </span>--config<span class="w"> </span>full
./scripts/parse_benchmark_info.py
cat<span class="w"> </span>benchmark.json
</pre></div>
</div>
<p>The main point of the above listing is the <code class="docutils literal notranslate"><span class="pre">synthesize.py</span></code> script, which creates an instance of the <code class="docutils literal notranslate"><span class="pre">Core</span></code> object with
the configuration provided by the user and then passes it to Amaranth to generate a Verilog description from that instance.
This description is then processed by Yosys and nextpnr-ecp5 to generate the ECP5 bitstream.</p>
<p>A strength of Coreblocks is its modularity, so we can provide different configurations with little effort. You can choose
a configuration to synthesise using the <code class="docutils literal notranslate"><span class="pre">--config</span></code> argument to the <code class="docutils literal notranslate"><span class="pre">synthesise.py</span></code> script.</p>
</div>
<div class="section" id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading"></a></h3>
<p>In order to perform synthesis we use:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/YosysHQ/yosys">yosys</a> - to synthesise the Verilog generated by Amaranth up to gate level;</p></li>
<li><p><a class="reference external" href="https://github.com/YosysHQ/nextpnr.git">nextpnr-ecp5</a> - to perform the “Place and Route” step;</p></li>
<li><p><a class="reference external" href="https://github.com/YosysHQ/prjtrellis">prjtrellis</a> - provides the description of the ECP5 bitstream format.</p></li>
</ul>
</div>
</div>
<div class="section" id="benchmarking">
<h2>Benchmarking<a class="headerlink" href="#benchmarking" title="Permalink to this heading"></a></h2>
<p>The maximum clock frequency determined by synthesis isn’t the only measure of performance. In theory, it is always
possible to increase Fmax by increasing latency. To avoid the pitfall of too long latency affecting the core
throughput, we monitor the number of instructions executed per clock cycle (IPC). We simulate the core with cycle
accuracy and run benchmarks written in C inside the simulation. The benchmarks are taken from
<a class="reference external" href="https://github.com/embench/embench-iot/tree/master">embench</a>.</p>
<p>The benchmarking is done in two steps. First, we compile the C programs into binary format. Second, we run the binaries
on the simulated core. To compile the code we use <a class="reference external" href="https://github.com/riscv/riscv-gnu-toolchain">riscv-gnu-toolchain</a>,
with glibc configured for different architectural subsets of RISC-V extensions (you can check the exact configuration in
<a class="reference external" href="https://github.com/kuznia-rdzeni/coreblocks/blob/master/docker/riscv-toolchain.Dockerfile">riscv-toolchain.Dockerfile</a>).</p>
<p>Once we have the binaries, we can run them in simulation. This is done using <a class="reference external" href="https://github.com/cocotb/cocotb">Cocotb</a> and
<a class="reference external" href="https://github.com/verilator/verilator">Verilator</a>. We use Amaranth features to generate Verilog code describing Coreblocks instance,
which is passed to Verilator for compilation. Cocotb controls the simulation and execution of the program by stubbing external
interfaces. Pre-compiled Verilator in a compatible version is available in <a class="reference external" href="https://github.com/kuznia-rdzeni/coreblocks/blob/master/docker/Verilator.Dockerfile">Verilator.Dockerfile</a>.</p>
<div class="section" id="benchmarks-manual-execution">
<h3>Benchmarks manual execution<a class="headerlink" href="#benchmarks-manual-execution" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ========== STEP 1: Compilation ==========</span>
<span class="c1"># Clone coreblocks into host file system</span>
git<span class="w"> </span>clone<span class="w"> </span>--depth<span class="o">=</span><span class="m">1</span><span class="w"> </span>https://github.com/kuznia-rdzeni/coreblocks.git
<span class="nb">cd</span><span class="w"> </span>coreblocks
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive
<span class="nb">cd</span><span class="w"> </span>..
sudo<span class="w"> </span>docker<span class="w"> </span>pull<span class="w"> </span>ghcr.io/kuznia-rdzeni/riscv-toolchain:latest
<span class="c1"># Run docker with the coreblocks directory mounted into it</span>
sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span>./coreblocks:/coreblocks<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>ghcr.io/kuznia-rdzeni/riscv-toolchain:latest
<span class="nb">cd</span><span class="w"> </span>/coreblocks/test/external/embench
<span class="c1"># Compilation will put binaries in the subdirectory of the /coreblocks directory, which is shared with the host</span>
<span class="c1"># so that binaries survive after the docker container is closed</span>
make
<span class="nb">exit</span>

<span class="c1"># ========== STEP 2: Execution ==========</span>
sudo<span class="w"> </span>docker<span class="w"> </span>pull<span class="w"> </span>ghcr.io/kuznia-rdzeni/verilator:latest
<span class="c1"># Run docker with the coreblocks directory mounted into it. This directory contains</span>
<span class="c1"># benchmark binaries after running the first step.</span>
sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span>./coreblocks:/coreblocks<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>ghcr.io/kuznia-rdzeni/verilator:latest
apt<span class="w"> </span>update
apt<span class="w"> </span>install<span class="w"> </span>python3.11-venv
python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
.<span class="w"> </span>venv/bin/activate
python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
<span class="nb">cd</span><span class="w"> </span>coreblocks
pip3<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements-dev.txt
<span class="nv">PYTHONHASHSEED</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>./scripts/gen_verilog.py<span class="w"> </span>--verbose<span class="w"> </span>--config<span class="w"> </span>full
./scripts/run_benchmarks.py
</pre></div>
</div>
</div>
</div>
<div class="section" id="regression-tests">
<h2>Regression tests<a class="headerlink" href="#regression-tests" title="Permalink to this heading"></a></h2>
<p>Regression tests should ensure that Coreblocks is compliant with RISC-V specification requirements. Tests include
assembler programs that tests entire RISC-V instruction set. We execute these programs in a similar way to benchmarks.
So, as a first step, we compile the programs to the binary format and then we run them on core simulated by Verilator
and Cocotb.</p>
<div class="section" id="regression-tests-manual-execution">
<h3>Regression tests manual execution<a class="headerlink" href="#regression-tests-manual-execution" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ========== STEP 1: Compilation ==========</span>
<span class="c1"># Clone coreblocks into host file system</span>
git<span class="w"> </span>clone<span class="w"> </span>--depth<span class="o">=</span><span class="m">1</span><span class="w"> </span>https://github.com/kuznia-rdzeni/coreblocks.git
<span class="nb">cd</span><span class="w"> </span>coreblocks
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive
<span class="nb">cd</span><span class="w"> </span>..
sudo<span class="w"> </span>docker<span class="w"> </span>pull<span class="w"> </span>ghcr.io/kuznia-rdzeni/riscv-toolchain:latest
<span class="c1"># Run docker with the coreblocks directory mounted into it</span>
sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span>./coreblocks:/coreblocks<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>ghcr.io/kuznia-rdzeni/riscv-toolchain:latest
<span class="nb">cd</span><span class="w"> </span>/coreblocks/test/external/riscv-tests
<span class="c1"># Compilation will put binaries in the subdirectory of the /coreblocks directory, which is shared with the host</span>
<span class="c1"># so that binaries survive after the docker container is closed</span>
make
<span class="nb">exit</span>

<span class="c1"># ========== STEP 2: Execution ==========</span>
sudo<span class="w"> </span>docker<span class="w"> </span>pull<span class="w"> </span>ghcr.io/kuznia-rdzeni/verilator:latest
<span class="c1"># Run docker with the coreblocks directory mounted into it. This directory contains</span>
<span class="c1"># regression test binaries after running the first step.</span>
sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-v<span class="w"> </span>./coreblocks:/coreblocks<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>ghcr.io/kuznia-rdzeni/verilator:latest
apt<span class="w"> </span>update
apt<span class="w"> </span>install<span class="w"> </span>python3.11-venv
python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
.<span class="w"> </span>venv/bin/activate
python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
<span class="nb">cd</span><span class="w"> </span>coreblocks
pip3<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements-dev.txt
<span class="nv">PYTHONHASHSEED</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>./scripts/gen_verilog.py<span class="w"> </span>--verbose<span class="w"> </span>--config<span class="w"> </span>full
./scripts/run_tests.py<span class="w"> </span>-a<span class="w"> </span>regression
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../problem-checklist.html" class="btn btn-neutral float-left" title="Problem checklist" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../components/icache.html" class="btn btn-neutral float-right" title="Instruction Cache" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Kuźnia Rdzeni, 2024.
      <span class="lastupdated">Last updated on 06:35 2024-10-15.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>